### ======================================================
### Bond Voyage API - Unified HTTP Request Samples
### ======================================================
### Notes:
### - Set @baseUrl to local or prod as needed.
### - Auth flows capture tokens using @name blocks.
### - Some flows require admin role or env keys.
### - No webhooks are defined in the API source at this time.

@localBaseUrl = http://localhost:8087/api/v1
@prodBaseUrl = https://bond-voyage-api-host.onrender.com/api/v1
@baseUrl = {{localBaseUrl}}

@email = user@example.com
@password = User@123
@adminEmail = admin@example.com
@adminPassword = Admin@123

@accessToken =
@userToken =
@bookingId =
@collaboratorId =
@tourPackageId =
@paymentId =
@inquiryId =
@feedbackId =
@notificationId =

### ======================================================
### 1. HEALTH + CORS
### ======================================================
### Health check
# Expected: 200 OK
GET {{baseUrl}}/health

### CORS preflight (adjust Origin to match CORS_ORIGINS)
# Expected: 204/200
OPTIONS {{baseUrl}}/health
Origin: https://bond-voyage.vercel.app
Access-Control-Request-Method: GET

### ======================================================
### 2. AUTHENTICATION
### ======================================================
### Register admin
# Expected: 201 Created
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstName": "Felix",
  "lastName": "Melgar",
  "email": "felixangelomelgar5@gmail.com",
  "mobile": "09612133522",
  "password": "Felix@123",
  "role": "ADMIN",
  "birthday": "2004-05-05"
}

### Register user
# Expected: 201 Created
POST {{baseUrl}}/auth/register
Content-Type: application/json

{
  "firstName": "Felix",
  "lastName": "Melgar",
  "email": "{{email}}",
  "mobile": "09612133520",
  "password": "{{password}}",
  "role": "USER",
  "birthday": "2004-05-05"
}

### Login as admin
# Expected: 200 OK (accessToken in data.accessToken)
# @name adminLogin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{adminEmail}}",
  "password": "{{adminPassword}}"
}

###
@accessToken = {{adminLogin.response.body.data.accessToken}}

### Login as user
# Expected: 200 OK (accessToken in data.accessToken)
# @name userLogin
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{email}}",
  "password": "{{password}}"
}

###
@userToken = {{userLogin.response.body.data.accessToken}}

### Login - Invalid credentials
# Expected: 401 Unauthorized
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "wrong@email.com",
  "password": "wrongpassword"
}

### Login - Missing password
# Expected: 400 Bad Request
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "email": "{{adminEmail}}"
}

### Login - Missing email
# Expected: 400 Bad Request
POST {{baseUrl}}/auth/login
Content-Type: application/json

{
  "password": "{{adminPassword}}"
}

### Refresh token (requires refreshToken cookie from login)
# Expected: 200 OK
POST {{baseUrl}}/auth/refresh-token

### Profile
# Expected: 200 OK
GET {{baseUrl}}/auth/profile
Authorization: Bearer {{userToken}}

### Logout (single device)
# Expected: 200 OK
POST {{baseUrl}}/auth/logout
Authorization: Bearer {{accessToken}}

### Logout all (all devices)
# Expected: 200 OK
POST {{baseUrl}}/auth/logout-all
Authorization: Bearer {{accessToken}}

### Send OTP
# Expected: 200 OK
POST {{baseUrl}}/auth/send-otp
Content-Type: application/json

{
  "email": "felixangelomelgar5@gmail.com",
  "firstName": "Felix"
}

### Verify OTP
# Expected: 200 OK (replace otp with real code)
POST {{baseUrl}}/auth/verify-otp
Content-Type: application/json

{
  "email": "felixangelomelgar5@gmail.com",
  "otp": "597871"
}

### Reset password (requires verified OTP session)
# Expected: 200 OK
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "email": "felixangelomelgar5@gmail.com",
  "newPassword": "Felix@1234"
}

### Reset password without OTP
# Expected: 401 Unauthorized
POST {{baseUrl}}/auth/reset-password
Content-Type: application/json

{
  "email": "{{email}}",
  "newPassword": "HackerPassword000!"
}

### ======================================================
### 3. USERS (ADMIN)
### ======================================================
@userId =

### List users (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/users?page=1&limit=10
Authorization: Bearer {{accessToken}}

### ======================================================
### 18. SCENARIO: AUTOCOMPLETE TO OPTIMIZATION FLOW
### ======================================================

### Step 1: Search for Start Point (Intramuros)
# We use @name to capture the response into a variable called 'searchOrigin'
# Expected: 200 OK
# @name searchOrigin
GET {{baseUrl}}/places/search?text=Intramuros&allowExternal=true

### Step 2: Search for a Middle Activity (Rizal Park)
# We capture this response as 'searchStop'
# Expected: 200 OK
# @name searchStop
GET {{baseUrl}}/places/search?text=Rizal Park&allowExternal=true

### Step 3: Search for Destination (Mall of Asia)
# We capture this response as 'searchDest'
# Expected: 200 OK
# @name searchDest
GET {{baseUrl}}/places/search?text=Mall of Asia&allowExternal=true

### Step 4: Optimize Route using Selected Locations
# We dynamically inject the lat/lng from the first result (index 0) of the previous searches.
# Expected: 200 OK with "optimizedActivities" and "routeGeometry"
POST {{baseUrl}}/routes/optimize
Content-Type: application/json
Authorization: Bearer {{userToken}}

{
  "mode": "drive",
  "activities": [
    {
      "id": "activity-start",
      "name": "Start: {{searchOrigin.response.body.data[0].name}}",
      "lat": {{searchOrigin.response.body.data[0].lat}},
      "lng": {{searchOrigin.response.body.data[0].lng}}
    },
    {
      "id": "activity-middle",
      "name": "Stop: {{searchStop.response.body.data[0].name}}",
      "lat": {{searchStop.response.body.data[0].lat}},
      "lng": {{searchStop.response.body.data[0].lng}}
    },
    {
      "id": "activity-end",
      "name": "End: {{searchDest.response.body.data[0].name}}",
      "lat": {{searchDest.response.body.data[0].lat}},
      "lng": {{searchDest.response.body.data[0].lng}}
    }
  ]
}

### Get user (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{accessToken}}

### Update user (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
PATCH {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "role": "USER",
  "isActive": true
}

### Deactivate user (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
PATCH {{baseUrl}}/users/{{userId}}/deactivate
Authorization: Bearer {{accessToken}}

### Delete user (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
DELETE {{baseUrl}}/users/{{userId}}
Authorization: Bearer {{accessToken}}

### Add user (admin)
# Expected: 201 Created
# Expected (non-admin): 403 Forbidden
POST {{baseUrl}}/users
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "firstName": "New",
  "lastName": "User",
  "email": "new.user@example.com",
  "mobile": "+1234567899",
  "password": "User@123",
  "role": "USER"
}

### Update my profile (user)
# Expected: 200 OK
PUT {{baseUrl}}/users/profile
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "firstName": "Updated",
  "lastName": "User",
  "mobile": "+1234567891"
}

### Change my password (user)
# Expected: 200 OK
PUT {{baseUrl}}/users/change-password
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "currentPassword": "{{password}}",
  "newPassword": "NewPassword456!"
}

### ======================================================
### 4. TOUR PACKAGES
### ======================================================
### List tour packages (public)
# Expected: 200 OK
GET {{baseUrl}}/tour-packages?page=1&limit=10

### Create tour package (admin)
# Expected: 201 Created
POST {{baseUrl}}/tour-packages
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "title": "Baguio Escape",
  "destination": "Baguio",
  "category": "City",
  "description": "2D/1N city escape",
  "price": 8000,
  "duration": 2,
  "thumbUrl": "https://example.com/baguio.jpg",
  "isActive": true,
  "days": [
    {
      "dayNumber": 1,
      "title": "Arrival",
      "activities": [
        { "time": "09:00", "title": "Check-in", "order": 1 }
      ]
    }
  ]
}

### Get tour package detail (public)
# Expected: 200 OK
GET {{baseUrl}}/tour-packages/{{tourPackageId}}

### Update tour package (admin)
# Expected: 200 OK
PUT {{baseUrl}}/tour-packages/{{tourPackageId}}
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "title": "Baguio Escape (Updated)",
  "destination": "Baguio",
  "category": "City",
  "description": "2D/1N updated",
  "price": 9000,
  "duration": 2,
  "thumbUrl": "https://example.com/baguio-updated.jpg",
  "isActive": true,
  "days": [
    {
      "dayNumber": 1,
      "title": "Arrival",
      "activities": [
        { "time": "09:00", "title": "Check-in", "order": 1 }
      ]
    }
  ]
}

### Delete tour package (admin)
# Expected: 200 OK
DELETE {{baseUrl}}/tour-packages/{{tourPackageId}}
Authorization: Bearer {{accessToken}}

### ======================================================
### 5. BOOKINGS (USER + ADMIN)
### ======================================================
### Create booking (user)
# Expected: 201 Created
# @name createBooking
POST {{baseUrl}}/bookings
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "destination": "El Nido, Palawan",
  "startDate": "2024-06-01T00:00:00.000Z",
  "endDate": "2024-06-03T00:00:00.000Z",
  "travelers": 2,
  "totalPrice": 25000,
  "type": "CUSTOMIZED",
  "tourType": "PRIVATE",
  "itinerary": [
    {
      "dayNumber": 1,
      "date": "2024-06-01T00:00:00.000Z",
      "activities": [
        { "time": "08:00 AM", "title": "Airport Pickup", "order": 1 }
      ]
    }
  ]
}

@bookingId = {{createBooking.response.body.data.id}}

### List my bookings (user)
# Expected: 200 OK
GET {{baseUrl}}/bookings/my-bookings?page=1&limit=10
Authorization: Bearer {{userToken}}

### Get booking detail (user)
# Expected: 200 OK
GET {{baseUrl}}/bookings/{{bookingId}}
Authorization: Bearer {{userToken}}

### Update booking itinerary (user)
# Expected: 200 OK
PUT {{baseUrl}}/bookings/{{bookingId}}
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "destination": "Coron, Palawan",
  "startDate": "2024-06-10T00:00:00.000Z",
  "endDate": "2024-06-12T00:00:00.000Z",
  "travelers": 3,
  "totalPrice": 30000,
  "itinerary": [
    {
      "dayNumber": 1,
      "date": "2024-06-10T00:00:00.000Z",
      "activities": [
        { "time": "09:00 AM", "title": "Island Hopping", "order": 1 }
      ]
    }
  ]
}

### Submit booking (user)
# Expected: 200 OK (DRAFT -> PENDING)
PATCH {{baseUrl}}/bookings/{{bookingId}}/submit
Authorization: Bearer {{userToken}}

### Cancel booking (user)
# Expected: 200 OK
PATCH {{baseUrl}}/bookings/{{bookingId}}/cancel
Authorization: Bearer {{userToken}}

### Delete draft booking (user, only DRAFT)
# Expected: 200 OK
DELETE {{baseUrl}}/bookings/{{bookingId}}
Authorization: Bearer {{userToken}}

### Shared with me (collaborator)
# Expected: 200 OK
GET {{baseUrl}}/bookings/shared-with-me?page=1&limit=10
Authorization: Bearer {{userToken}}

### Admin: list all bookings
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/bookings/admin/bookings?page=1&limit=10&status=PENDING
Authorization: Bearer {{accessToken}}

### Admin: reject booking
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
PATCH {{baseUrl}}/bookings/{{bookingId}}/status
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "status": "REJECTED",
  "rejectionReason": "Dates fully booked",
  "rejectionResolution": "Select dates after June 10"
}

### Admin: approve booking
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
PATCH {{baseUrl}}/bookings/{{bookingId}}/status
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "status": "CONFIRMED"
}

### ======================================================
### 6. COLLABORATORS
### ======================================================
### Add collaborator (owner)
# Expected: 201 Created
POST {{baseUrl}}/bookings/{{bookingId}}/collaborators
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "email": "collab@example.com"
}

### List collaborators (owner or collaborator)
# Expected: 200 OK
GET {{baseUrl}}/bookings/{{bookingId}}/collaborators
Authorization: Bearer {{userToken}}

### Remove collaborator (owner)
# Expected: 200 OK
DELETE {{baseUrl}}/bookings/{{bookingId}}/collaborators/{{collaboratorId}}
Authorization: Bearer {{userToken}}

### ======================================================
### 7. PAYMENTS
### ======================================================
### Submit payment proof (user)
# Expected: 201 Created
# @name submitPayment
POST {{baseUrl}}/bookings/{{bookingId}}/payments
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "amount": 10000,
  "method": "GCASH",
  "type": "PARTIAL",
  "proofImageBase64": "aGVsbG8=",
  "proofMimeType": "image/png",
  "transactionId": "TXN-10001"
}

@paymentId = {{submitPayment.response.body.data.id}}

### List payments (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/payments?page=1&limit=10&status=PENDING&bookingId={{bookingId}}
Authorization: Bearer {{accessToken}}

### Booking payments list (owner/admin)
# Expected: 200 OK
GET {{baseUrl}}/bookings/{{bookingId}}/payments?page=1&limit=10&status=PENDING
Authorization: Bearer {{accessToken}}

### Verify payment (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
PATCH {{baseUrl}}/payments/{{paymentId}}/status
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "status": "VERIFIED"
}

### Download payment proof (owner/admin)
# Expected: raw bytes (Content-Type = proofMimeType or application/octet-stream)
GET {{baseUrl}}/payments/{{paymentId}}/proof
Authorization: Bearer {{accessToken}}

### ======================================================
### 8. INQUIRIES + MESSAGES
### ======================================================
### Create inquiry (user)
# Expected: 201 Created
# @name createInquiry
POST {{baseUrl}}/inquiries
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "subject": "Visa Requirements",
  "message": "Do we need a visa?"
}

@inquiryId = {{createInquiry.response.body.data.id}}

### List inquiries (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/inquiries
Authorization: Bearer {{accessToken}}

### Add message (admin)
# Expected: 201 Created
# Expected (non-admin): 403 Forbidden
POST {{baseUrl}}/inquiries/{{inquiryId}}/messages
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "content": "Please share your nationality."
}

### ======================================================
### 9. FEEDBACK
### ======================================================
### Submit feedback (user)
# Expected: 201 Created
# @name createFeedback
POST {{baseUrl}}/feedback
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "rating": 5,
  "comment": "Great service!"
}

@feedbackId = {{createFeedback.response.body.data.id}}

### List feedback (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/feedback
Authorization: Bearer {{accessToken}}

### Respond to feedback (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
PATCH {{baseUrl}}/feedback/{{feedbackId}}/respond
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "response": "Thanks for your feedback!"
}

### ======================================================
### 10. ACTIVITY LOGS
### ======================================================
### List activity logs (admin)
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/activity-logs?page=1&limit=10
Authorization: Bearer {{accessToken}}

### ======================================================
### 11. NOTIFICATIONS
### ======================================================
### List notifications (user)
# Expected: 200 OK
GET {{baseUrl}}/notifications
Authorization: Bearer {{userToken}}

### Mark notification as read (user)
# Expected: 200 OK
PATCH {{baseUrl}}/notifications/{{notificationId}}/read
Authorization: Bearer {{userToken}}

### ======================================================
### 12. WEATHER
### ======================================================
### Weather lookup (requires OPENWEATHER_API_KEY)
# Expected: 200 OK
GET {{baseUrl}}/weather?lat=14.5995&lng=120.9842

### Weather forecast (returns mock if OPENWEATHER_API_KEY missing)
# Expected: 200 OK
GET {{baseUrl}}/weather/forecast?lat=14.5995&lng=120.9842

### ======================================================
### 13. ROUTE OPTIMIZATION
### ======================================================
### Optimize route (requires GEOAPIFY_API_KEY or fallback)
# Expected: 200 OK
POST {{baseUrl}}/routes/optimize
Content-Type: application/json

{
  "origin": { "lat": 14.5995, "lng": 120.9842 },
  "destination": { "lat": 16.4023, "lng": 120.5960 },
  "waypoints": [{ "lat": 15.0, "lng": 120.5 }]
}

### ======================================================
### 14. CHATBOTS
### ======================================================
### Roameo (static)
# Expected: 200 OK
POST {{baseUrl}}/chatbots/roameo
Content-Type: application/json

{
  "message": "How do I create a booking?"
}

### Roaman (requires GEMINI_API_KEY)
# Expected: 200 OK
POST {{baseUrl}}/chatbots/roaman
Content-Type: application/json

{
  "message": "Build a 3-day Palawan itinerary.",
  "context": "User prefers beaches and light activities."
}

### ======================================================
### 15. AI ITINERARY
### ======================================================
### Generate AI itinerary (stub)
# Expected: 200 OK
POST {{baseUrl}}/ai/itinerary
Content-Type: application/json

{
  "destination": "Palawan",
  "startDate": "2025-01-10",
  "endDate": "2025-01-12"
}

### ======================================================
### 16. DASHBOARD (ADMIN)
### ======================================================
### Admin stats
# Expected: 200 OK
# Expected (non-admin): 403 Forbidden
GET {{baseUrl}}/dashboard/stats
Authorization: Bearer {{accessToken}}

### ======================================================
### 17. AUDIT LOGS (ADMIN)
### ======================================================
### List audit logs
# Expected: 200 OK
GET {{baseUrl}}/admin/audit-logs?page=1&limit=5&action=BOOKING
Authorization: Bearer {{accessToken}}

### Get audit log by id (replace :id from list response)
# Expected: 200 OK
GET {{baseUrl}}/admin/audit-logs/{{logId}}
Authorization: Bearer {{accessToken}}

### ======================================================
### SMOKE TEST: DATE HANDLING
### ======================================================

### 1. Create a Test User (to ensure we have a record created "Today")
# Expected: 201 Created
# @name createDateUser
POST {{baseUrl}}/auth/register
Authorization: Bearer {{accessToken}}
Content-Type: application/json

{
  "firstName": "Date",
  "lastName": "Tester",
  "email": "date.tester@example.com",
  "mobile": "09999999999",
  "password": "User@123",
  "role": "USER",
  "birthday": "1990-01-01" 
}

### 2. Search exact range (TODAY)
# Replace '2026-01-04' with the ACTUAL CURRENT DATE you are running this test.
# Expected: 200 OK (Should include the 'Date Tester' user)
# Logic Check: This proves the backend converts "2026-01-04" -> "2026-01-04T00:00:00" to "2026-01-04T23:59:59"
GET {{baseUrl}}/users?startDate=2026-01-04&endDate=2026-01-04
Authorization: Bearer {{accessToken}}

### 3. Search past range (YESTERDAY)
# Replace with yesterday's date.
# Expected: 200 OK (Should NOT include 'Date Tester')
GET {{baseUrl}}/users?startDate=2026-01-03&endDate=2026-01-03
Authorization: Bearer {{accessToken}}

### ======================================================
### 14. ITINERARY VERSIONING (requires authenticated user)
### ======================================================

### Create itinerary (captures version 1 and history)
# @name createItinerary
POST {{baseUrl}}/itineraries
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "destination": "Cebu",
  "startDate": "2025-06-01",
  "endDate": "2025-06-05",
  "travelers": 2,
  "days": [
    {
      "dayNumber": 1,
      "activities": [
        { "time": "09:00", "title": "Arrive", "order": 0 },
        { "time": "14:00", "title": "Beach walk", "order": 1 }
      ]
    }
  ]
}

### Extract variables from response
@itineraryId = {{createItinerary.response.body.data.id}}
@itineraryVersion = {{createItinerary.response.body.data.version}}

### Update itinerary with optimistic concurrency (expect 200)
# @name updateItinerary
PATCH {{baseUrl}}/itineraries/{{itineraryId}}
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "destination": "Cebu City",
  "travelers": 3,
  "version": {{itineraryVersion}},
  "days": [
    {
      "dayNumber": 1,
      "activities": [
        { "time": "09:30", "title": "Brunch", "order": 0 },
        { "time": "13:00", "title": "Museum", "order": 1 }
      ]
    }
  ]
}

### Extract updated version
@updatedVersion = {{updateItinerary.response.body.data.version}}

### Simulate conflict with stale version (expect 409)
PATCH {{baseUrl}}/itineraries/{{itineraryId}}
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "destination": "Cebu - stale",
  "travelers": 4,
  "version": 1,
  "days": [
    {
      "dayNumber": 1,
      "activities": [
        { "time": "11:00", "title": "Old brunch", "order": 0 }
      ]
    }
  ]
}

### List itinerary versions (metadata only)
# @name listVersions
GET {{baseUrl}}/itineraries/{{itineraryId}}/versions
Authorization: Bearer {{userToken}}

### Extract first version ID from list
@firstVersionId = {{listVersions.response.body.data[0].id}}

### Retrieve a specific version snapshot (owner/collaborator)
GET {{baseUrl}}/itineraries/{{itineraryId}}/versions/{{firstVersionId}}
Authorization: Bearer {{userToken}}

### Restore a specific version (owner/admin only) with OCC
POST {{baseUrl}}/itineraries/{{itineraryId}}/versions/{{firstVersionId}}/restore
Authorization: Bearer {{userToken}}
Content-Type: application/json

{
  "version": {{updatedVersion}}
}
