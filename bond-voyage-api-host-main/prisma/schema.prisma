// schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// =========================================
// ENUMS
// =========================================

enum UserRole {
  USER
  ADMIN
}

enum ItineraryType {
  STANDARD
  CUSTOMIZED
  REQUESTED
  SMART_TRIP
}

enum ItineraryStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
  ARCHIVED
}

enum RequestStatus {
  DRAFT
  SENT
  CONFIRMED
}

enum BookingType {
  STANDARD // Booked from a pre-made package
  CUSTOMIZED // Built by user (or AI)
  REQUESTED // Custom quote requested by user
}

enum BookingStatus {
  DRAFT // User is still building it
  PENDING // Submitted for Admin approval
  CONFIRMED // Approved by Admin
  REJECTED // Returned to user for changes
  COMPLETED // Trip finished
  CANCELLED // Terminated
}

enum TourType {
  JOINER
  PRIVATE
}

enum PaymentType {
  FULL
  PARTIAL
}

enum PaymentMethod {
  CASH
  GCASH
}

enum PaymentStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum CollaboratorRole {
  OWNER
  COLLABORATOR
}

enum InquiryStatus {
  OPEN
  CLOSED
}

enum NotificationType {
  BOOKING
  PAYMENT
  INQUIRY
  FEEDBACK
  SYSTEM
}

// =========================================
// CORE MODELS
// =========================================

model User {
  id         String    @id @default(uuid())
  email      String    @unique @db.VarChar(255)
  password   String // Hashed
  firstName  String?   @db.VarChar(50)
  middleName String?   @db.VarChar(50)
  lastName   String?   @db.VarChar(50)
  birthday   DateTime?
  employeeId String?   @unique
  mobile     String    @unique @db.VarChar(20)
  role       UserRole  @default(USER)
  avatarUrl  String?

  // Auth & Security
  refreshTokens String[]  @default([])
  isActive      Boolean   @default(true)
  lastLogin     DateTime?

  // Admin Specific Fields
  companyName    String?
  customerRating Decimal? @db.Decimal(3, 2)
  yearsInOperation Int?

  // Relations
  bookings              Booking[]
  itineraries           Itinerary[]
  collaborations        ItineraryCollaborator[]
  invitedCollaborations ItineraryCollaborator[] @relation("itinerary_invites")
  feedback              Feedback[]
  respondedFeedback     Feedback[]              @relation("feedback_responses")
  activityLogs          ActivityLog[]
  inquiries             Inquiry[]
  messages              Message[]
  notifications         Notification[]
  paymentSubmissions    Payment[]               @relation("payment_submissions")
  createdItineraryVersions ItineraryVersion[]   @relation("itinerary_versions_created")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("users")
}

// For "Standard" trips (Templates created by Admins)
model TourPackage {
  id          String  @id @default(uuid())
  title       String
  destination String
  category    String?
  description String?

  price    Decimal @db.Decimal(10, 2)
  duration Int // Number of days
  thumbUrl String?
  isActive Boolean @default(true)

  days TourPackageDay[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tour_packages")
}

model Itinerary {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  title         String?
  destination   String
  startDate     DateTime?
  endDate       DateTime?
  travelers     Int       @default(1)
  estimatedCost Decimal?  @db.Decimal(10, 2)
  travelPace    String?
  preferences   String[]  @default([])

  type     ItineraryType   @default(CUSTOMIZED)
  status   ItineraryStatus @default(DRAFT)
  tourType TourType        @default(PRIVATE)
  version  Int             @default(1)

  // Track Admin-to-User flow for "Requested" itineraries
  sentStatus      String? // e.g., "Draft", "Sent to User"
  requestedStatus RequestStatus @default(DRAFT)
  sentAt          DateTime?
  confirmedAt     DateTime?

  // Rejection/Resolution Logic
  rejectionReason     String?
  rejectionResolution String?
  isResolved          Boolean @default(false)

  days          ItineraryDay[]
  collaborators ItineraryCollaborator[]
  bookings      Booking[]
  inquiries     Inquiry[]
  versions      ItineraryVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("itineraries")
}

model ItineraryVersion {
  id          String   @id @default(uuid())
  itineraryId String
  itinerary   Itinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  version  Int
  snapshot Json
  createdById String?
  createdBy   User?    @relation("itinerary_versions_created", fields: [createdById], references: [id])

  createdAt DateTime @default(now())

  @@unique([itineraryId, version])
  @@map("itinerary_versions")
}

// =========================================
// ITINERARY STRUCTURE
// =========================================

model ItineraryDay {
  id          String    @id @default(uuid())
  itineraryId String
  itinerary   Itinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)

  dayNumber Int // 1, 2, 3...
  title       String?
  date      DateTime?

  activities Activity[]

  @@unique([itineraryId, dayNumber])
  @@map("itinerary_days")
}

model Activity {
  id             String       @id @default(uuid())
  itineraryDayId String
  itineraryDay   ItineraryDay @relation(fields: [itineraryDayId], references: [id], onDelete: Cascade)

  time        String
  title       String
  description String?
  location    String?
  icon        String?

  order Int

  @@map("activities")
}

model ItineraryCollaborator {
  id          String           @id @default(uuid())
  itineraryId String
  itinerary   Itinerary        @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  userId      String
  user        User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  invitedById String?
  invitedBy   User?            @relation("itinerary_invites", fields: [invitedById], references: [id])
  role        CollaboratorRole @default(COLLABORATOR)
  addedAt     DateTime         @default(now())

  @@unique([itineraryId, userId])
  @@map("itinerary_collaborators")
}

// =========================================
// TRANSACTIONAL BOOKING
// =========================================

model Booking {
  id          String    @id @default(uuid())
  itineraryId String
  itinerary   Itinerary @relation(fields: [itineraryId], references: [id], onDelete: Cascade)
  userId      String
  user        User      @relation(fields: [userId], references: [id])

  bookingCode String @unique

  destination String?
  startDate   DateTime?
  endDate     DateTime?
  travelers   Int?      @default(1)

  // Customer Data (captured from the Standard Itinerary modal)
  customerName   String?  // Optional for CUSTOMIZED/REQUESTED bookings
  customerEmail  String?  // Only used for STANDARD bookings
  customerMobile String?  // Only collected in Standard Itinerary modal
  bookedDate     DateTime @default(now())

  totalPrice Decimal @db.Decimal(10, 2)
  userBudget Decimal? @db.Decimal(10, 2)

  type     BookingType   @default(CUSTOMIZED)
  status   BookingStatus @default(PENDING)
  tourType TourType      @default(PRIVATE)

  // Payment Visibility (requested for "get my bookings")
  paymentStatus     PaymentStatus @default(PENDING) //
  paymentReceiptUrl String? // URL to uploaded GCash/Receipt image

  rejectionReason     String?
  rejectionResolution String?
  isResolved          Boolean @default(false)

  payments  Payment[]
  inquiries Inquiry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("bookings")
}

model BookingSequence {
  id             Int     @id @default(autoincrement())
  year           Int
  currentNumber  Int     @default(0)
  lastIssuedCode String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([year])
  @@map("booking_sequences")
}

// =========================================
// LOCATION CATALOG
// =========================================

model Location {
  id          String   @id @default(uuid())
  name        String   @unique
  alias       String[]
  latitude    Float
  longitude   Float
  imageUrl    String?
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("locations")
}

// =========================================
// FINANCIALS
// =========================================

model Payment {
  id            String  @id @default(uuid())
  bookingId     String
  booking       Booking @relation(fields: [bookingId], references: [id])
  submittedById String?
  submittedBy   User?   @relation("payment_submissions", fields: [submittedById], references: [id])

  amount Decimal       @db.Decimal(10, 2)
  method PaymentMethod @default(GCASH)
  status PaymentStatus @default(PENDING)
  type   PaymentType   @default(PARTIAL)

  proofImage    Bytes?
  proofMimeType String?
  proofSize     Int?
  transactionId String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("payments")
}

// =========================================
// LOGGING & FEEDBACK
// =========================================

model Feedback {
  id            String  @id @default(uuid())
  userId        String
  user          User    @relation(fields: [userId], references: [id])
  respondedById String?
  respondedBy   User?   @relation("feedback_responses", fields: [respondedById], references: [id])

  rating      Int
  comment     String?
  response    String?
  respondedAt DateTime?

  createdAt DateTime @default(now())

  @@map("feedbacks")
}

model ActivityLog {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id])

  action  String
  details String?

  timestamp DateTime @default(now())

  @@map("activity_logs")
}

// =========================================
// STANDARD ITINERARIES
// =========================================

model TourPackageDay {
  id            String      @id @default(uuid())
  tourPackageId String
  tourPackage   TourPackage @relation(fields: [tourPackageId], references: [id], onDelete: Cascade)

  dayNumber Int
  title     String?

  activities TourPackageActivity[]

  @@unique([tourPackageId, dayNumber])
  @@map("tour_package_days")
}

model TourPackageActivity {
  id               String         @id @default(uuid())
  tourPackageDayId String
  tourPackageDay   TourPackageDay @relation(fields: [tourPackageDayId], references: [id], onDelete: Cascade)

  time        String
  title       String
  description String?
  location    String?
  icon        String?
  order       Int

  @@map("tour_package_activities")
}

// =========================================
// INQUIRY & MESSAGING
// =========================================

model Inquiry {
  id          String     @id @default(uuid())
  userId      String
  user        User       @relation(fields: [userId], references: [id])
  bookingId   String?
  booking     Booking?   @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  itineraryId String?
  itinerary   Itinerary? @relation(fields: [itineraryId], references: [id], onDelete: SetNull)

  subject String
  status  InquiryStatus @default(OPEN)

  messages Message[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("inquiries")
}

model Message {
  id        String  @id @default(uuid())
  inquiryId String
  inquiry   Inquiry @relation(fields: [inquiryId], references: [id], onDelete: Cascade)

  senderId String
  sender   User    @relation(fields: [senderId], references: [id])
  content  String
  isRead   Boolean @default(false)

  sentAt DateTime @default(now())

  @@map("messages")
}

// =========================================
// FAQ ENTRIES (RAG SOURCE)
// =========================================

model FaqEntry {
  id        String   @id @default(uuid())
  question  String
  answer    String
  order     Int
  isActive  Boolean  @default(true)

  tags           String[]  @default([])
  targetPages    String[]  @default([])
  pageKeywords   String[]  @default([])
  category       String    @default("user") // Maps to 'systemCategory'

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("faq_entries")
}

// =========================================
// NOTIFICATIONS
// =========================================

model Notification {
  id        String           @id @default(uuid())
  userId    String
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type      NotificationType @default(SYSTEM)
  title     String?
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  createdAt DateTime         @default(now())

  @@map("notifications")
}
